<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reservations - Hotel Reservation System</title>
    <!-- Bootstrap CSS CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        .status-badge {
            font-size: 0.8em;
            padding: 0.4em 0.6em;
        }
        .action-buttons .btn {
            font-size: 0.75em;
            padding: 0.25em 0.5em;
            margin: 0.1em;
        }
        .filter-badge {
            cursor: pointer;
        }
        .table-responsive {
            max-height: 600px;
        }
    </style>
</head>
<body>
    <!-- Navigation - Temporarily commented out for testing -->
    <!-- <div th:replace="~{navbar :: navbar}"></div> -->

    <!-- Main Content -->
    <div class="container mt-4">
        <!-- Page Header -->
        <div class="row mb-4">
            <div class="col">
                <h1 class="display-6">
                    <i class="bi bi-calendar-check text-primary"></i> Reservations Management System
                </h1>
                <p class="text-muted">Manage restaurant reservations</p>
            </div>
        </div>

        <!-- Success/Error Messages -->
        <div th:if="${success}" class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="bi bi-check-circle"></i>
            <span th:text="${success}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        <div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="bi bi-exclamation-triangle"></i>
            <span th:text="${error}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>

        <!-- Status Filter Section -->
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="card-title mb-0">
                    <i class="bi bi-funnel"></i> Filter by Status
                </h6>
            </div>
            <div class="card-body">
                <div class="d-flex flex-wrap gap-2">
                    <span class="badge filter-badge bg-secondary" data-filter-status="ALL" onclick="filterByStatus(this.dataset.filterStatus)">
                        All <span class="badge bg-light text-dark" th:text="${reservations != null ? reservations.size() : 0}">0</span>
                    </span>
                    <span class="badge filter-badge bg-warning" data-filter-status="PENDING" onclick="filterByStatus(this.dataset.filterStatus)">
                        Pending <span class="badge bg-light text-dark" th:text="${reservations != null ? #lists.size(reservations.?[status.name() == 'PENDING']) : 0}">0</span>
                    </span>
                    <span class="badge filter-badge bg-success" data-filter-status="CONFIRMED" onclick="filterByStatus(this.dataset.filterStatus)">
                        Confirmed <span class="badge bg-light text-dark" th:text="${reservations != null ? #lists.size(reservations.?[status.name() == 'CONFIRMED']) : 0}">0</span>
                    </span>
                    <span class="badge filter-badge bg-info" data-filter-status="SEATED" onclick="filterByStatus(this.dataset.filterStatus)">
                        Seated <span class="badge bg-light text-dark" th:text="${reservations != null ? #lists.size(reservations.?[status.name() == 'SEATED']) : 0}">0</span>
                    </span>
                    <span class="badge filter-badge bg-primary" data-filter-status="IN_SERVICE" onclick="filterByStatus(this.dataset.filterStatus)">
                        In Service <span class="badge bg-light text-dark" th:text="${reservations != null ? #lists.size(reservations.?[status.name() == 'IN_SERVICE']) : 0}">0</span>
                    </span>
                    <a class="badge filter-badge bg-secondary text-decoration-none" href="#completed-reservations-card">
                        Completed <span class="badge bg-light text-dark" th:text="${completedCount != null ? completedCount : 0}">0</span>
                    </a>
                    <span class="badge filter-badge bg-danger" data-filter-status="CANCELLED" onclick="filterByStatus(this.dataset.filterStatus)">
                        Cancelled <span class="badge bg-light text-dark" th:text="${reservations != null ? #lists.size(reservations.?[status.name() == 'CANCELLED']) : 0}">0</span>
                    </span>
                </div>
            </div>
        </div>

        <!-- Active Reservations Content -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="bi bi-table"></i> Active Reservations
                </h5>
                <div>
                    <span class="badge bg-light text-dark" th:text="${reservations != null ? reservations.size() : 0}">0</span> active
                </div>
            </div>
            <div class="card-body">
                <div th:if="${reservations != null and !reservations.empty}">
                    <div class="table-responsive">
                        <table class="table table-hover" id="active-reservations-table">
                            <thead class="table-light">
                                <tr>
                                    <th>ID</th>
                                    <th>Customer</th>
                                    <th>Phone</th>
                                    <th>Table</th>
                                    <th>Reservation Time</th>
                                    <th>Party Size</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr th:each="reservation : ${reservations}">
                                    <td th:text="${reservation.id}"></td>
                                    <td>
                                        <strong th:text="${reservation.customerName}"></strong>
                                    </td>
                                    <td th:text="${reservation.customerPhone}"></td>
                                    <td>
                                        <span class="badge bg-info" th:text="${reservation.table.tableNumber}"></span>
                                        <br>
                                        <small class="text-muted">Capacity: <span th:text="${reservation.table.capacity}"></span></small>
                                    </td>
                                    <td th:text="${#temporals.format(reservation.reservationTime, 'MMM dd, yyyy HH:mm')}"></td>
                                    <td>
                                        <span class="badge bg-secondary" th:text="${reservation.partySize}"></span>
                                    </td>
                                    <td>
                                        <span th:switch="${reservation.status != null ? reservation.status.name() : 'UNKNOWN'}" 
                                              th:attr="data-status=${reservation.status != null ? reservation.status.name() : 'UNKNOWN'}"
                                              class="badge status-badge">
                                            <span th:case="'PENDING'" class="badge bg-warning text-dark">Pending</span>
                                            <span th:case="'CONFIRMED'" class="badge bg-success">Confirmed</span>
                                            <span th:case="'SEATED'" class="badge bg-info text-dark">Seated</span>
                                            <span th:case="'IN_SERVICE'" class="badge bg-primary">In Service</span>
                                            <span th:case="'COMPLETED'" class="badge bg-secondary">Completed</span>
                                            <span th:case="'CANCELLED'" class="badge bg-danger">Cancelled</span>
                                            <span th:case="*" class="badge bg-dark">Unknown</span>
                                        </span>
                                    </td>
                                    <td>
                                        <div class="action-buttons">
                                            <!-- PENDING Actions -->
                                            <div th:if="${reservation.status.name() == 'PENDING'}">
                                                <form th:action="@{/reservations/{id}/status(id=${reservation.id})}" method="post" style="display: inline;">
                                                    <input type="hidden" name="status" value="CONFIRMED">
                                                    <button type="submit" class="btn btn-success btn-sm" title="Confirm Reservation">
                                                        <i class="bi bi-check-lg"></i> Confirm
                                                    </button>
                                                </form>
                                                <form th:action="@{/reservations/{id}/cancel(id=${reservation.id})}" method="post" style="display: inline;">
                                                    <button type="submit" class="btn btn-danger btn-sm" title="Cancel Reservation">
                                                        <i class="bi bi-x-lg"></i> Cancel
                                                    </button>
                                                </form>
                                            </div>
                                            
                                            <!-- CONFIRMED Actions -->
                                            <div th:if="${reservation.status.name() == 'CONFIRMED'}">
                                                <form th:action="@{/reservations/{id}/status(id=${reservation.id})}" method="post" style="display: inline;">
                                                    <input type="hidden" name="status" value="SEATED">
                                                    <button type="submit" class="btn btn-info btn-sm" title="Mark as Seated">
                                                        <i class="bi bi-person-check"></i> Seat
                                                    </button>
                                                </form>
                                                <form th:action="@{/reservations/{id}/cancel(id=${reservation.id})}" method="post" style="display: inline;">
                                                    <button type="submit" class="btn btn-danger btn-sm" title="Cancel Reservation">
                                                        <i class="bi bi-x-lg"></i> Cancel
                                                    </button>
                                                </form>
                                            </div>
                                            
                                            <!-- SEATED Actions -->
                                            <div th:if="${reservation.status.name() == 'SEATED'}">
                                                <form th:action="@{/reservations/{id}/status(id=${reservation.id})}" method="post" style="display: inline;">
                                                    <input type="hidden" name="status" value="IN_SERVICE">
                                                    <button type="submit" class="btn btn-primary btn-sm" title="Mark as In Service">
                                                        <i class="bi bi-cup-hot"></i> Service
                                                    </button>
                                                </form>
                                            </div>
                                            
                                            <!-- IN_SERVICE Actions -->
                                            <div th:if="${reservation.status.name() == 'IN_SERVICE'}">
                                                <form th:action="@{/reservations/{id}/status(id=${reservation.id})}" method="post" style="display: inline;">
                                                    <input type="hidden" name="status" value="COMPLETED">
                                                    <button type="submit" class="btn btn-secondary btn-sm" title="Move to Completed">
                                                        <i class="bi bi-check2-all"></i> Complete
                                                    </button>
                                                </form>
                                            </div>
                                            
                                            <!-- CANCELLED - No actions -->
                                            <div th:if="${reservation.status.name() == 'CANCELLED'}">
                                                <span class="text-muted small">No actions</span>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div th:if="${reservations == null or reservations.empty}" class="text-center py-5">
                    <i class="bi bi-calendar-x display-1 text-muted"></i>
                    <h4 class="text-muted mt-3">No Active Reservations</h4>
                    <p class="text-muted">Start by creating your first reservation.</p>
                    <a href="/reservations/new" class="btn btn-primary">
                        <i class="bi bi-plus-circle"></i> Create Reservation
                    </a>
                </div>
            </div>
        </div>

        <!-- Completed Reservations -->
        <div class="card mt-4" id="completed-reservations-card">
            <div class="card-header d-flex flex-wrap justify-content-between align-items-center">
                <div>
                    <h5 class="card-title mb-0">
                        <i class="bi bi-check2-circle"></i> Completed Reservations
                    </h5>
                    <small class="text-muted">Completed reservations are moved here automatically</small>
                </div>
                <div class="text-end">
                    <span class="badge bg-success" th:text="${completedCount != null ? completedCount : 0}">0</span> total
                </div>
            </div>
            <div class="card-body">
                <form class="row gy-2 gx-2 align-items-end mb-3" method="get" action="/reservations">
                    <div class="col-sm-4 col-md-3">
                        <label for="completedDate" class="form-label mb-0">Filter by date</label>
                        <input type="date" id="completedDate" name="completedDate" class="form-control"
                               th:value="${completedDate != null ? completedDate : ''}">
                    </div>
                    <div class="col-auto">
                        <button type="submit" class="btn btn-outline-primary">
                            <i class="bi bi-funnel"></i> Apply
                        </button>
                    </div>
                    <div class="col-auto">
                        <a href="/reservations" class="btn btn-outline-secondary">
                            <i class="bi bi-arrow-counterclockwise"></i> Reset
                        </a>
                    </div>
                    <div class="col-auto ms-auto" th:if="${completedDate != null}">
                        <span class="badge bg-light text-dark">Showing <span th:text="${#temporals.format(completedDate, 'MMM dd, yyyy')}"></span></span>
                    </div>
                </form>

                <div th:if="${completedReservations != null and !completedReservations.empty}">
                    <div class="table-responsive">
                        <table class="table table-striped" id="completed-reservations-table">
                            <thead class="table-light">
                                <tr>
                                    <th>ID</th>
                                    <th>Customer</th>
                                    <th>Table</th>
                                    <th>Reservation Time</th>
                                    <th>Party Size</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr th:each="reservation : ${completedReservations}">
                                    <td th:text="${reservation.id}"></td>
                                    <td>
                                        <strong th:text="${reservation.customerName}"></strong>
                                        <br>
                                        <small class="text-muted" th:text="${reservation.customerPhone}"></small>
                                    </td>
                                    <td>
                                        <span class="badge bg-info" th:text="${reservation.table.tableNumber}"></span>
                                    </td>
                                    <td th:text="${#temporals.format(reservation.reservationTime, 'MMM dd, yyyy HH:mm')}"></td>
                                    <td>
                                        <span class="badge bg-secondary" th:text="${reservation.partySize}"></span>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div th:if="${completedReservations == null or completedReservations.empty}" class="text-center py-4 text-muted">
                    <i class="bi bi-inboxes display-5"></i>
                    <p class="mt-2 mb-0">No completed reservations found for the selected criteria.</p>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="row mt-4">
            <div class="col-md-6">
                <a href="/reservations/new" class="btn btn-primary btn-lg">
                    <i class="bi bi-plus-circle"></i> New Reservation
                </a>
                <a href="/" class="btn btn-outline-secondary btn-lg ms-2">
                    <i class="bi bi-house"></i> Dashboard
                </a>
            </div>
            <div class="col-md-6 text-end">
                <a href="/tables" class="btn btn-outline-info btn-lg">
                    <i class="bi bi-table"></i> Manage Tables
                </a>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS CDN -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Custom JavaScript -->
    <script>
        function filterByStatus(status) {
            const rows = document.querySelectorAll('#active-reservations-table tbody tr');
            if (!rows.length) {
                return;
            }

            rows.forEach(row => {
                if (status === 'ALL') {
                    row.style.display = '';
                    return;
                }

                const statusCell = row.querySelector('td:nth-child(7) span[data-status]');
                if (statusCell && statusCell.getAttribute('data-status') === status) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
            
            document.querySelectorAll('.filter-badge[data-filter-status]').forEach(badge => {
                badge.classList.remove('border', 'border-2', 'border-dark');
                if (badge.dataset.filterStatus === status) {
                    badge.classList.add('border', 'border-2', 'border-dark');
                }
            });
        }
        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            // Add confirmation for cancel actions
            document.querySelectorAll('form[action*="cancel"] button').forEach(button => {
                button.addEventListener('click', function(e) {
                    if (!confirm('Are you sure you want to cancel this reservation?')) {
                        e.preventDefault();
                    }
                });
            });
        });
    </script>
    
    <!-- Footer -->
    <div th:replace="~{footer :: footer}"></div>
</body>
</html>